<html>
    <head>
        <% include ./partials/head.ejs %>
            <link rel="stylesheet" type="text/css" href="../assets/css/irrigation/irrigation.css">
            <link rel="stylesheet" href="../assets/css/irrigation/datepicker.css">
            
            <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
    <body>
        <header>
            <% include ./partials/header.ejs %>
        </header>
        <div class="layout">
            <div class="SelectedMode" style="padding-top:20px">

                <div class="dropdown">
                    <label for="myDropdown"><strong> Irrigation Mode </strong> &nbsp; &nbsp;</label>

                    <select id="myDropdown">
					<option value="1" <% if (irrigationmode == 'auto') { %>selected<% } %>  ><strong>Auto</strong></option>
                    <option value="2" <% if (irrigationmode == 'scheduled') { %>selected<% } %>><strong>Scheduled</strong></option>
                    <option value="3" <% if (irrigationmode == 'manual') { %>selected<% } %>><strong>Manual</strong></option>
        </select>
                </div>
                <hr>
                <div class="AutoMode clearfix" style="padding-top:10px; padding-bottom:10px;" id="auto">
                    <div class="col-lg-3 col-md-5 col-sm-5">
                    </div>
                    <div class="col-lg-6 col-md-2 col-sm-2">

                        <strong> Auto Mode</strong></br>
                        The system takes the decision whether to turn on or off the irrigation based on the sensor's data

                    </div>
                    <div class="col-lg-3 col-md-5 col-sm-5">

                    </div>

                </div>
                <div class="ScheduledMode" style="display:none;" id="schedule">
                    <h3>Schedule</h3>
                    <table class="table" id="scheduleTable" align="center">
                        <th ><center>Date </center></th>
                        <th> <center>Time </center></th>
                        <th></th>
                       <tr><td colspan="4"> <center>  <button id="AddBtn" type="button " width="20px" class="btn c-datepicker-btn  btn-rounded mb-4" ><span  id="AddBtnSpan" class="glyphicon glyphicon-plus" background="green"></span>Add Schedule&nbsp;</button></center></td></tr>
                        <tbody id="tbody">
                        </tbody>
                       

                    </table>

                </div>

                <div class="ManualMode clearfix " style="display:none; padding-top:35px; padding-bottom:25px;" id="manual">

                    <div class="col-lg-4 col-md-5 col-sm-5">

                    </div>
                    <div class="col-lg-4 col-md-2 col-sm-2 ">


                        <label for="switch">Irrigation status</label><label class="switch "><input type="checkbox" id="ManualtogBtn" value="Off"><div class="slider round"></div></label>

                    </div class="col-lg-4 col-md-5 col-sm-5">
                    <div>

                    </div>

                </div>


            </div>
         



            <script>
                /* When the user clicks on the button, 
                            toggle between hiding and showing the dropdown content */
                            var x = '<%=irrigationmode%>';
                $(function () {


                    var modeOnload = x;

                    if (modeOnload == 'auto') {
                        $('#auto').show();
                        $('#manual').hide();
                        $('#schedule').hide();
                    } else if (modeOnload == 'scheduled') {
                        $('#auto').hide();
                        $('#manual').hide();
                        $('#schedule').show();

                        var reqData = "farmid=" + <%=fid%> + "&siteid=" + <%=sid%>;
                        AjaxRequestGetSchedule("https://agripronode.herokuapp.com/api/getAllSchedules", reqData);


                    } else if (modeOnload == 'manual') {
                        $('#schedule').hide();
                        $('#auto').hide();
                        $('#manual').show();
                    }

                });
                //changes the current div to show the selected mode's options
                $("#myDropdown").change(function () {


                    console.log("dopdown val :  " + $(this).val());

                    if ($(this).val() == 1) {

                        $('#auto').show();
                        $('#manual').hide();
                        $('#schedule').hide();

                        console.log("Auto mode selected");
                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "https://agripronode.herokuapp.com/api/setIrrigationMode", true);
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                console.log(this.responseText);
                            } else {
                                console.log("error in output: " + this.responseText);
                            }
                        };

                        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        xhttp.send("farmid=" + <%= fid %> + "&siteid=" + <%= sid %> + "&mode=auto");


                    } else if ($(this).val() == 2) {


                        $('#auto').hide();
                        $('#manual').hide();
                        $('#schedule').show();

                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "https://agripronode.herokuapp.com/api/setIrrigationMode", true);
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                console.log("correct " + this.responseText);
                            } else {
                                console.log("error in output: " + this.responseText);
                            }
                        };

                        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        xhttp.send("farmid=" + <%=fid%> + "&siteid=" + <%=sid%> + "&mode=scheduled");
                        var reqData = "farmid=" + <%=fid%> + "&siteid=" + <%=sid%>;
                        AjaxRequestGetSchedule("https://agripronode.herokuapp.com/api/getAllSchedules", reqData);


                    } else if ($(this).val() == 3) {
                        $('#schedule').hide();
                        $('#auto').hide();
                        $('#manual').show();

                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "https://agripronode.herokuapp.com/api/setIrrigationMode", true);
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                console.log(this.responseText);
                            } else {
                                console.log("error in output: " + this.responseText);
                            }
                        };

                        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        xhttp.send("farmid=" + <%=fid%> + "&siteid=" + <%=sid%> + "&mode=manual");


                    }

                })

                //Turn theirrigation status on/off (Manual mode)
                $("#ManualtogBtn").click(function () {

                    if ($("#ManualtogBtn").val() == "Off") {
                        $("#ManualtogBtn").val("On");
                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "https://agripronode.herokuapp.com/api/setIrrigationStatus", true);
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                console.log(this.responseText);
                            } else {
                                console.log("error in output: " + this.responseText);
                            }
                        };

                        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        xhttp.send("farmid=" + <%=fid%> + "&siteid=" + <%=sid%> + "&status=1");


                    } else {
                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "https://agripronode.herokuapp.com/api/setIrrigationStatus", true);
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                console.log(this.responseText);
                            } else {
                                console.log("error in output: " + this.responseText);
                            }
                        };

                        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        xhttp.send("farmid=" + <%=fid%> + "&siteid=" + <%=sid%> + "&status=0");


                        $("#AutotogBtn").val("Off");


                    }


                    //       

                    console.log($("#AutotogBtn").val());
                    // var xhttp = new XMLHttpRequest();
                    ///////////////////////////////////////////MIN value set            
                    //Sets the SM's min value

                });

                function myFunction() {
                    document.getElementById("myDropdown").classList.toggle("show");
                }


                // Close the dropdown menu if the user clicks outside of it
                window.onclick = function (event) {
                    if (!event.target.matches('.dropbtn')) {

                        var dropdowns = document.getElementsByClassName("dropdown-content");
                        var i;
                        for (i = 0; i < dropdowns.length; i++) {
                            var openDropdown = dropdowns[i];
                            if (openDropdown.classList.contains('show')) {
                                openDropdown.classList.remove('show');
                            }
                        }
                    }
                }

                //Responsibilities: gets the latest schedule of the selected site and updates the schdule table with it
                //inputs:
                // url
                // data
                // outputs:
                //     Complete schedule

                function AjaxRequestGetSchedule(url, data) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", url, true);
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {


                            console.log(this.responseText);
                            // console.log(this.responseText.length);
                            console.log("type of object:   ------------  " + typeof responseText);
                            var revData = JSON.parse(this.responseText);
                            var timeArr = [];
                            console.log("type of object: ------" + revData);

                            // var oldTable = document.getElementById('scheduleTable'),
                            // newTable = oldTable.cloneNode(true);
                            // var row;
                            Object.keys(revData).forEach(function (dateNode) {
                                // console.log(dateNode);
                                timeArr.push(dateNode);
                                // console.log(dateNode["addtime"]);
                                var child = revData[dateNode];
                                console.log(dateNode);
                                //console.log("child---- " + JSON.stringify(child['addtime']));
                                // console.log(dateNode[0]);
                                var sdate,stime;
                                splittedDateNode=dateNode.split(" ");
                                sdate=splittedDateNode[1];
                                stime=splittedDateNode[3];
                               deBtn = ["glyphicon","glyphicon-trash"];
                                 $('#tbody').append('<tr align=\"center\" id=\"Date '+sdate+' Time '+stime+'\"><td>'+ sdate +'</td><td>' + stime +  '</td><td><button class=\"btn btn-danger\" onclick=\"delSchedule()\"><span class=\"glyphicon glyphicon-trash\"></span></button></td></tr>');
                                
                                    // var tr = "<tr><td>"+ sdate +"</td><td>" + stime + " </td><td><span class="+"glyphicon glyphicon-trash"+"></span></td></tr>";
                                    
                                    // row.append(tr);
                            });

                            //oldTable.parentNode.replaceChild(newTable, oldTable);
                            // $("#scheduleTable").innerHtml=row;
                            

                        } else {
                            console.log("error in output: " + this.responseText);

                        }
                    };

                    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    xhttp.send(data);

                }


                function delSchedule(){
                    $(this).closest('tr').attr('id');
                    
                }
            </script>

            <footer>
                <% include ./partials/footer.ejs %>
            </footer>
    </body>

</html>